define(["jquery","core/log","core/config"],function(a,b,c){var d={eulas:"required",shopid:0,units:0,required:0,assigned:0,endusermobilephonerequired:0,strings:[],init:function(c){a(".shop-description-toggle").bind("click",this.toggle_description),a(".local-shop-detail-delete").bind("click",this.clear_product),a(".local-shop-order-detail").bind("change",this.update_product),a(".local-shop-password").bind("keypress",this.check_pass_code),a(".local-shop-email").bind("change",this.check_email),a(".local-shop-add-unit").bind("click",this.add_unit),a(".local-shop-delete-unit").bind("click",this.delete_unit),a(".local-shop-add-assign").bind("change",this.add_assign),a(".local-shop-delete-assign").bind("click",this.delete_assign),a(".local-shop-toggle-invoiceinfo").bind("change",this.toggle_invoiceinfo),a(".local-shop-delete-user").bind("click",this.delete_user),a(".local-shop-add-user").bind("click",this.add_user),c&&(d.shopid=c.shopid,d.units=c.units,d.required=c.required,d.assigned=c.assigned,d.endusermobilephonerequired=c.endusermobilephonerequired),b.debug("AMD Local Shop Front initialized")},initeulas:function(c){a("#shop-eula-confirm").bind("click",this.accept_eulas),c&&("required"===c.eulas&&a("#region-pre").css("display","none"),d.eulas=c.eulas),b.debug("AMD Local Shop Front Eulas initialized")},toggle_description:function(){var b=a(this);b.attr("src").match("/open/")?(b.attr("src",b.attr("src").replace("open","close")),b.parent().parent().children(".shop-front-description").removeClass("shop-desc-gradient")):(b.attr("src",b.attr("src").replace("close","open")),b.parent().parent().children(".shop-front-description").addClass("shop-desc-gradient"))},toggle_invoiceinfo:function(){var b;this.checked?(a("#shop-invoiceinfo-wrapper").css("display","block"),""==document.driverform.elements["invoiceinfo::organisation"].value&&(b=document.driverform.elements["invoiceinfo::organisation"],b.value=document.driverform.elements["customerinfo::organisation"].value),""==document.driverform.elements["invoiceinfo::city"].value&&(b=document.driverform.elements["invoiceinfo::city"],b.value=document.driverform.elements["customerinfo::city"].value)):a("#shop-invoiceinfo-wrapper").css("display","none")},accept_eulas:function(){var b;1==a("#shop-agreeeula").val()?(a("#euladiv").css("display","none"),a("#order").css("display","block"),a("#order").css("visibility","show"),a("#region-pre").css("display","block"),a("#region-pre").css("visibility","show"),b=c.wwwroot+"/local/shop/front/ajax/service.php",b+="?what=agreeeulas",b+="&service=order",b+="&id="+d.shopid):(b=c.wwwroot+"/local/shop/front/ajax/service.php",b+="?what=reseteulas",b+="&service=order",b+="&id="+d.shopid),a.get(b)},reset_eulas:function(){if("agreed"==d.eulas){var b=c.wwwroot+"/local/shop/front/ajax/service.php";b+="?what=reseteulas",b+="&service=order",b+="&id="+d.shopid,a.get(b)}},add_assign:function(){var b,e,f=a(this),g=f.attr("data-role"),h=f.attr("data-product"),i=c.wwwroot+"/local/shop/front/ajax/service.php",j=JSON.parse(f.attr("data-requiredroles"));for(e in j)b=j[e],a("#"+b+"list"+h).html(d.waiter());a.post(i,{id:d.shopid,service:"users",what:"addassign",role:g,product:h,participantid:this.options[this.selectedIndex].value},function(c){var f=JSON.parse(c);for(e in j)b=j[e],a("#"+b+"list"+h).html(f.content[b]);d.assigned++,d.assigned<d.required?(a("#next-button").css("opacity","0.5"),a("#next-button").removeClass("shop-active-button"),a("#next-button").attr("disabled","disabled"),a("#next-button").attr("title",d.strings[1])):(a("#next-button").css("opacity","1.0"),a("#next-button").addClass("shop-active-button"),a("#next-button").attr("disabled",null),a("#next-button").attr("title",d.strings[2]))},"html")},delete_assign:function(b,e,f){var g,h,i=a(this),b=i.attr("data-role"),e=i.attr("data-product"),f=i.attr("data-email"),j=c.wwwroot+"/local/shop/front/ajax/service.php",k=i.attr("data-requiredroles");for(h in k)g=k[h],a("#"+g+"list"+e).html(d.waiter());a.post(j,{id:d.shopid,service:"users",what:"deleteassign",role:b,product:e,participantid:f},function(b){var c=JSON.parse(b);for(h in k)g=k[h],a("#"+g+"list"+e).html(c.content[g]);d.assigned--,d.assigned<0&&(d.assigned=0),d.assigned<d.required?(a("#next-button").css("opacity","0.5"),a("#next-button").removeClass("shop-active-button"),a("#next-button").attr("disabled","disabled"),a("#next-button").attr("title",d.strings[1])):(a("#next-button").css("opacity","1.0"),a("#next-button").addClass("shop-active-button"),a("#next-button").attr("disabled",null),a("#next-button").attr("title",d.strings[2]))},"html")},add_unit:function(e){e.stopPropagation(),e.preventDefault();var f=a(this),g=f.attr("data-product"),h=c.wwwroot+"/local/shop/front/ajax/service.php";a("#bag_"+g).html(d.waiter()),a.post(h,{id:d.shopid,service:"shop",what:"addunit",productname:g},function(c){var e=JSON.parse(c);a("#bag_"+g).html(e.html),d.update_details(),d.update_totals();var h=f.attr("data-maxquant");b.debug(h+">="+e.quant),h>0&&e.quant>=h&&(b.debug("disabling product add button "+g),a("#ci-"+g).attr("disabled","disabled"))},"html"),d.units++,a("#next-button").attr("disabled",null),a("#next-button").addClass("shop-active-button"),a("#next-button").css("opacity","1.0"),a("#next-button").attr("title",d.strings[2])},delete_unit:function(e){e.stopPropagation(),e.preventDefault();var f=a(this),g=f.attr("data-product"),h=c.wwwroot+"/local/shop/front/ajax/service.php";a("#bag_"+g).html(d.waiter()),a.post(h,{id:d.shopid,service:"shop",what:"deleteunit",productname:g,clearall:0},function(c){var e=JSON.parse(c);a("#bag_"+g).html(e.html),d.update_details(),d.update_totals(),b.debug("enabling product add button "+g),a("#ci-"+g).attr("disabled",null)},"html"),d.units--,0==d.units&&(a("#next-button").attr("disabled","disabled"),a("#next-button").removeClass("shop-active-button"),a("#next-button").css("opacity","0.5"),a("#next-button").attr("title",d.strings[3]))},clear_product:function(b){b.stopPropagation(),b.preventDefault();var e=a(this),f=e.attr("data-product"),g=c.wwwroot+"/local/shop/front/ajax/service.php";a("#bag_"+f).html(d.waiter()),a("#id_"+f).val(0),a("#ci-"+f).attr("disabled",null),a("#id_total_"+f).val(0),a.post(g,{id:d.shopid,service:"shop",what:"deleteunit",productname:f,clearall:1},function(b){var c=JSON.parse(b);a("#bag_"+f).html(c.html),d.update_details(),d.update_totals()},"html")},update_product:function(b){b.stopPropagation(),b.preventDefault();var e=a(this),f=e.attr("data-product"),g=e.attr("data-maxquant"),h=c.wwwroot+"/local/shop/front/ajax/service.php",i=a("#id_"+f).val();g>0&&i>g&&(i=g),a("#id_"+f).val(i),a("#bag_"+f).html(d.waiter()),a.post(h,{id:d.shopid,service:"shop",what:"setunits",productname:f,quant:i},function(b){var c=JSON.parse(b);a("#bag_"+f).html(c.html),d.update_details(),d.update_totals()},"html")},update_totals:function(){var b=c.wwwroot+"/local/shop/front/ajax/service.php";a("#shop-ordertotals").html(d.waiter()),a.post(b,{id:d.shopid,service:"shop",what:"ordertotals"},function(b){var c=JSON.parse(b);a("#shop-ordertotals").html(c.html),a(".local-shop-detail-delete").unbind("click"),a(".local-shop-detail-delete").bind("click",d.clear_product),a(".local-shop-order-detail").unbind("change"),a(".local-shop-order-detail").bind("change",d.update_product)},"html")},update_details:function(){var b=c.wwwroot+"/local/shop/front/ajax/service.php";a("#order-detail").html(d.waiter()),a.post(b,{id:d.shopid,service:"shop",what:"orderdetails"},function(b){var c=JSON.parse(b);a("#order-detail").html(c.html),a(".local-shop-delete-unit").unbind("click"),a(".local-shop-delete-unit").bind("click",d.delete_unit)},"html")},add_user:function(){var b=a(this),e=document.forms.participant,f=c.wwwroot+"/local/shop/front/ajax/service.php",g=b.attr("data-requiredroles"),h=g.split(","),i=b.attr("data-products"),j=i.split(","),k=new Object;k.lastname=e.lastname.value,k.firstname=e.firstname.value,k.email=e.email.value,k.city=e.city.value,d.enduserorganisationrequired||(k.institution=e.institution.value),d.endusermobilephonerequired||(k.phone2=e.phone2.value),a("#participantlist").html(d.waiter()),a.post(f,{id:d.shopid,service:"users",what:"addparticipant",participant:JSON.stringify(k),roles:JSON.stringify(h)},function(b){var c,e,g;for(a("#participantlist").html(b),c=new Object,c.lastname.value="",c.firstname.value="",c.email.value="",d.endusermobilephonerequired||(c.phone2.value=""),e=0;e<h.length;e++)for(g=0;g<j.length;g++)a("#"+h[e]+"list"+j[g]).html(d.waiter());a.post(f,{id:d.shopid,service:"users",what:"assignalllistobj"},function(b){var c,d,e,f,g,i;for(g=JSON.parse(b),c=0;c<h.length;c++)for(e=h[c],d=0;d<j.length;d++)f=j[d],i=g.content[e][f],a("#"+e+"list"+f).html(i)},"html")})},delete_user:function(){var b=a(this),e=b.attr("data-ptmail"),f=c.wwwroot+"/local/shop/front/ajax/service.php",g=b.attr("data-requiredroles"),h=g.split(","),i=b.attr("data-products"),j=i.split(",");a("#participantlist").html(d.waiter()),a.post(f,{id:d.shopid,service:"users",what:"deleteparticipant",participantid:e,roles:JSON.stringify(h)},function(b){a("#participantlist").html(b);var c,e;for(c=0;c<h.length;c++)for(e=0;e<j.length;e++)a("#"+h[c]+"list"+j[e]).html(d.waiter());a.post(f,{id:d.shopid,service:"users",what:"assignalllistobj"},function(b){var c,d,e,f,g,i;for(g=JSON.parse(b),c=0;c<h.length;c++)for(e=h[c],d=0;d<j.length;d++)f=j[d],i=g.content[e][f],a("#"+e+"list"+f).html(i)},"html")})},check_pass_code:function(b){var e=a(this),f=e.attr("data-product"),g=c.wwwroot+"/local/shop/front/ajax/service.php",h='<img width="14" height="14" src="'+c.wwwroot+'/local/shop/pix/ajaxloader.gif" />',i='<img width="14" height="14" src="'+c.wwwroot+'/local/shop/pix/valid.png" />',j='<img width="14" height="14" src="'+c.wwwroot+'/local/shop/pix/invalid.png" />';a("#ci-pass-status-"+f).html(h);var k=e.val()+b.key;a.post(g,{id:d.shopid,service:"shop",what:"checkpasscode",productname:f,passcode:k},function(b){var c=JSON.parse(b);"passed"==c.status?(a("#ci-"+f).attr("disabled",null),a("#ci-pass-status-"+f).html(i)):a("#ci-pass-status-"+f).html(j)},"html")},check_email:function(){var b=a(this);return!!/^\w+([\.+-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(b.val())||(alert(d.strings[0]),b.val(""),!1)},waiter:function(){return'<div class="ajax-waiter"><center><img src="'+c.wwwroot+'/local/shop/pix/loading29.gif" /><center></div>'},open_popup:function(b){var c=a(this),b=c.attr("data-target");window.open(b,"product","width=400,height=500,toolbar=0,menubar=0,statusbar=0")},openSalesPopup:function(){var a="width=600,height=600,toolbar=0,menubar=0,statusbar=0, resizable=1,scrollbars=1";window.open(c.wwwroot+"/local/shop/popup.php?p=sales","sales",a)}};return d});